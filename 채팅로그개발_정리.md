========================================
FoxChat 채팅로그 시스템 개발 정리
========================================

개발자: 우르사 (20주년 하드코어 클래식 서버, Fox and Wolf 길드)
개발 기간: 2025년 9월

----------------------------------------
1. 프로젝트 개요
----------------------------------------
World of Warcraft Classic 1.15 애드온 FoxChat의 채팅 로그 시스템 개발
- 채팅 내역을 자동으로 저장하고 검색/조회할 수 있는 기능
- 설정 UI를 통한 직관적인 관리 인터페이스
- 날짜별 로그 관리 및 세션 구분 기능

----------------------------------------
2. 주요 파일 구조
----------------------------------------
/FoxChat/
├── FoxChatLogger.lua          # 채팅 로그 핵심 모듈
├── FoxChat_Config_TabUI.lua   # UI 설정 및 탭 시스템
├── FoxChat.lua                 # 메인 애드온 파일
└── FoxChat.toc                 # 애드온 정보 파일

----------------------------------------
3. 핵심 기능
----------------------------------------

3.1 채팅 로그 저장
- 모든 채팅 채널의 메시지를 자동으로 기록
- 채널별 필터링 가능 (길드/파티/공격대/일반/외침/귓속말)
- 타임스탬프와 함께 저장
- 세션 타임아웃 기능 (기본 30분)

3.2 로그 조회 인터페이스
- 날짜 선택 기능 (달력 UI)
- 채널별 필터링 드롭다운
- 읽기 전용 텍스트 에디터 스타일 표시
- 스크롤 가능한 대용량 로그 지원

3.3 검색 기능
- 실시간 텍스트 검색
- 검색 결과 하이라이트
- 검색 결과 클릭 시 컨텍스트 팝업 (앞뒤 3줄 표시)
- 비동기 처리로 UI 블로킹 방지

3.4 내보내기 기능
- 선택한 날짜의 로그를 텍스트로 내보내기
- 복사 가능한 에디터 창 제공
- Ctrl+A로 전체 선택 지원

----------------------------------------
4. 기술적 구현 사항
----------------------------------------

4.1 데이터 저장 구조
FoxChatDB.chatLogs = {
    ["20250929"] = {  -- YYYYMMDD 형식
        {
            ts = timestamp,   -- 유닉스 타임스탬프
            ch = "G",        -- 채널 코드
            s = "발신자",     -- 보낸 사람
            t = "수신자",     -- 받는 사람 (귓속말)
            m = "메시지",     -- 메시지 내용
            o = 0/1          -- 발신(1)/수신(0)
        }
    }
}

4.2 UI 구현
- CreateTextArea 함수를 활용한 스크롤 가능 텍스트 영역
- UIPanelScrollFrameTemplate 기반 스크롤바
- 읽기 전용 EditBox로 복사는 가능하나 수정 불가
- FULLSCREEN_DIALOG 프레임 레벨로 팝업 최상위 표시

4.3 성능 최적화
- 대용량 로그 처리를 위한 비동기 검색
- 한 번에 100개씩 처리하여 UI 프리징 방지
- 로그 보존 기간 설정 (기본 7일)
- 오래된 로그 자동 정리

----------------------------------------
5. 주요 해결 과제
----------------------------------------

5.1 초기 오류 수정
문제: "bad argument #1 to 'pairs' (table expected, got nil)"
해결: FoxChatDB.chatLogs nil 체크 추가 (FoxChatLogger.lua:123-127)

5.2 모듈 등록 불일치
문제: "채팅로그 시스템을 불러올 수 없습니다"
해결: addon.ChatLogger → addon.FoxChatLogger 일관성 있게 변경

5.3 폰트 설정 오류
문제: "bad argument #3 to 'SetFont'"
해결: SetFont 호출 시 빈 문자열 "" 플래그 추가

5.4 UI 개선
- FauxScrollFrame 방식에서 CreateTextArea 에디터 스타일로 전환
- 메시지 영역 높이 조정 (320 → 280 픽셀)
- 검색 결과 클릭 시 컨텍스트 팝업 구현
- 프레임 레이어 우선순위 조정

5.5 변수 스코프 문제
- currentMessages 중복 선언 제거
- 전방 선언으로 함수 간 참조 문제 해결

----------------------------------------
6. 사용자 인터페이스
----------------------------------------

6.1 메인 UI 구성
┌─────────────────────────────────────┐
│  [날짜 선택 ▼] [채널: 전체 ▼]      │ <- 컨트롤 패널
├─────────────────────────────────────┤
│  검색: [___________] (0개 결과)      │ <- 검색 패널
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │ [12:34:56][길드] 우르사: 안녕│    │ <- 메시지 영역
│  │ [12:35:01][파티] 누군가: ㅎㅇ│    │    (스크롤 가능)
│  │ ...                          │    │
│  └─────────────────────────────┘    │
├─────────────────────────────────────┤
│  [내보내기]  [기본값 복원] [닫기]    │ <- 하단 버튼
└─────────────────────────────────────┘

6.2 컨텍스트 팝업
검색 결과 클릭 시 표시되는 팝업 창
- 선택한 메시지의 앞뒤 3줄 표시
- 이동 가능한 팝업 창
- 닫기 버튼 제공

----------------------------------------
7. 설정 옵션
----------------------------------------
- 채팅 로그 활성화/비활성화
- 세션 타임아웃 설정 (기본 30분)
- 로그 보존 기간 (기본 7일)
- 채널별 로깅 활성화 설정

----------------------------------------
8. 향후 개선 가능 사항
----------------------------------------
- 로그 파일 외부 저장 기능
- 고급 검색 옵션 (정규식, 날짜 범위)
- 통계 기능 (채팅 빈도, 활동 시간대 등)
- 메시지 북마크 기능
- 로그 압축 저장

----------------------------------------
9. 개발 노트
----------------------------------------
- WoW Classic 1.15 API 제약사항 고려
- 한글 인코딩 처리 주의
- 메모리 사용량 모니터링 필요
- 대용량 로그 처리 시 성능 테스트 권장

========================================
문서 작성일: 2025년 9월 29일
========================================