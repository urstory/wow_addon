# Fox Chat 파티원 참가 인사 기능 개선 계획

## 현재 구현 상태 분석

### 기존 기능
1. **내가 파티 참가 시 인사** (`autoGreetOnMyJoin`)
   - 여러 줄 입력 가능 (줄바꿈으로 구분)
   - 랜덤하게 하나 선택하여 발송
   - `{me}` 변수로 내 이름 치환

2. **다른 사람 파티 참가 시 인사** (`autoGreetOnOthersJoin`)
   - 여러 줄 입력 가능 (줄바꿈으로 구분)
   - 랜덤하게 하나 선택하여 발송
   - `{name}` 변수로 참가자 이름 치환

3. **현재 채널 결정 로직**
   - 파티: "PARTY" 채널 사용
   - 공격대: "RAID" 또는 "RAID_WARNING" 채널 사용

### 파일 구조
- `FoxChat.lua`: 메인 로직 (인사 발송 함수)
- `FoxChat_Config_TabUI.lua`: UI 구성 (자동 탭 내 인사 메뉴)

## 개선 요구사항

### 새로운 기능
1. **공대장일 때 인사말**
   - 여러 줄 입력 (랜덤 아닌 전체 발송)
   - 공대 경보(RAID_WARNING) 채널 사용

2. **파티장일 때 인사말**
   - 여러 줄 입력 (랜덤 아닌 전체 발송)
   - 파티 채팅(PARTY) 채널 사용

3. **우선순위 로직**
   - 공대장/파티장이면 → 전용 인사말 전체 발송
   - 일반 멤버면 → 기존 랜덤 인사말 발송

## 구현 계획

### 1단계: 데이터 구조 추가
```lua
-- FoxChatDB에 추가할 필드
FoxChatDB.leaderGreetRaidMessages = ""    -- 공대장일 때 인사말 (여러 줄)
FoxChatDB.leaderGreetPartyMessages = ""   -- 파티장일 때 인사말 (여러 줄)
```

### 2단계: UI 수정 (FoxChat_Config_TabUI.lua)
인사 메뉴 섹션에 추가:

1. **기존 레이아웃 유지**
   - "내가 파티에 참가할 때 인사" (기존)
   - "다른 사람이 파티에 참가할 때 인사" (기존)

2. **새로운 섹션 추가**
   - 구분선 추가
   - "리더 전용 인사말" 제목
   - "내가 공대장일 때" TextArea
   - "내가 파티장일 때" TextArea

### 3단계: 로직 수정 (FoxChat.lua)

#### SendOthersJoinGreeting 함수 수정
```lua
local function SendOthersJoinGreeting(targetName)
    if not FoxChatDB or not FoxChatDB.autoGreetOnOthersJoin then return end
    if not targetName or targetName == "" then return end

    -- 리더 체크
    local isRaidLeader = IsInRaid() and UnitIsGroupLeader("player")
    local isPartyLeader = IsInGroup() and not IsInRaid() and UnitIsGroupLeader("player")

    local messages = {}
    local sendAllLines = false  -- 전체 발송 여부

    if isRaidLeader and FoxChatDB.leaderGreetRaidMessages and FoxChatDB.leaderGreetRaidMessages ~= "" then
        -- 공대장 전용 인사말 사용
        messages = {strsplit("\n", FoxChatDB.leaderGreetRaidMessages)}
        sendAllLines = true
    elseif isPartyLeader and FoxChatDB.leaderGreetPartyMessages and FoxChatDB.leaderGreetPartyMessages ~= "" then
        -- 파티장 전용 인사말 사용
        messages = {strsplit("\n", FoxChatDB.leaderGreetPartyMessages)}
        sendAllLines = true
    else
        -- 기존 로직: 일반 인사말 사용 (랜덤)
        if not FoxChatDB.othersJoinMessages or FoxChatDB.othersJoinMessages == "" then return end
        messages = {strsplit("\n", FoxChatDB.othersJoinMessages)}
        sendAllLines = false
    end

    -- 메시지 발송
    if sendAllLines then
        -- 모든 줄 순차적으로 발송
        for _, msg in ipairs(messages) do
            local trimmed = string.gsub(msg, "^%s*(.-)%s*$", "%1")
            if trimmed ~= "" then
                -- {name} 치환
                local finalMsg = string.gsub(trimmed, "{name}", targetName)
                -- 채널 결정 및 발송
                local channel = GetAppropriateChannel()
                SendChatMessage(finalMsg, channel)
            end
        end
    else
        -- 기존 로직: 랜덤 선택
        -- ... 기존 코드 ...
    end
end
```

### 4단계: TextArea 구현 세부사항

#### UI 배치
```lua
-- 구분선 추가
local separator = CreateSeparator(greetContent)
separator:SetPoint("TOPLEFT", othersJoinBackground, "BOTTOMLEFT", -25, -20)

-- 리더 전용 섹션 제목
local leaderTitle = greetContent:CreateFontString(nil, "OVERLAY", "GameFontNormal")
leaderTitle:SetPoint("TOPLEFT", separator, "BOTTOMLEFT", 0, -10)
leaderTitle:SetText("리더 전용 인사말")

-- 공대장 인사말
local raidLeaderLabel = greetContent:CreateFontString(nil, "OVERLAY", "GameFontNormalSmall")
raidLeaderLabel:SetPoint("TOPLEFT", leaderTitle, "BOTTOMLEFT", 0, -10)
raidLeaderLabel:SetText("내가 공대장일 때 (모든 줄이 순서대로 출력):")

local raidLeaderBg, raidLeaderEditBox = CreateTextArea(greetContent, 400, 80, 0)
raidLeaderBg:SetPoint("TOPLEFT", raidLeaderLabel, "BOTTOMLEFT", 0, -5)

-- 파티장 인사말
local partyLeaderLabel = greetContent:CreateFontString(nil, "OVERLAY", "GameFontNormalSmall")
partyLeaderLabel:SetPoint("TOPLEFT", raidLeaderBg, "BOTTOMLEFT", 0, -15)
partyLeaderLabel:SetText("내가 파티장일 때 (모든 줄이 순서대로 출력):")

local partyLeaderBg, partyLeaderEditBox = CreateTextArea(greetContent, 400, 80, 0)
partyLeaderBg:SetPoint("TOPLEFT", partyLeaderLabel, "BOTTOMLEFT", 0, -5)
```

### 5단계: 저장 및 로드
```lua
-- 저장 (OnTextChanged 이벤트)
raidLeaderEditBox:SetScript("OnTextChanged", function(self)
    if FoxChatDB then
        FoxChatDB.leaderGreetRaidMessages = self:GetText() or ""
    end
end)

partyLeaderEditBox:SetScript("OnTextChanged", function(self)
    if FoxChatDB then
        FoxChatDB.leaderGreetPartyMessages = self:GetText() or ""
    end
end)

-- 로드 (초기화 시)
if FoxChatDB then
    raidLeaderEditBox:SetText(FoxChatDB.leaderGreetRaidMessages or "")
    partyLeaderEditBox:SetText(FoxChatDB.leaderGreetPartyMessages or "")
end
```

## 테스트 시나리오

1. **파티장으로 테스트**
   - 파티 생성
   - 파티장 인사말 설정 (여러 줄)
   - 다른 플레이어 초대
   - 모든 줄이 순서대로 출력되는지 확인

2. **공대장으로 테스트**
   - 공격대 생성
   - 공대장 인사말 설정 (여러 줄)
   - 다른 플레이어 초대
   - RAID_WARNING 채널로 모든 줄이 출력되는지 확인

3. **일반 멤버로 테스트**
   - 리더가 아닌 상태에서 다른 사람 참가
   - 기존 랜덤 인사말이 정상 작동하는지 확인

## 예상 문제 및 해결

1. **메시지 발송 간격**
   - 여러 줄 발송 시 스팸 방지를 위해 딜레이 추가 고려
   - `C_Timer.After` 사용하여 0.5초 간격으로 발송

2. **채널 권한 체크**
   - RAID_WARNING 권한 없을 경우 RAID로 폴백

3. **UI 공간 부족**
   - 스크롤 가능한 영역으로 구성
   - TextArea 크기 조정 가능

## 구현 우선순위

1. UI 추가 (TextArea 2개)
2. 데이터 저장/로드 로직
3. SendOthersJoinGreeting 함수 수정
4. 테스트 및 디버깅