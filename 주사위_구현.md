# FoxChat 주사위 집계 기능 - 현재 상태 및 미해결 문제

## 개요
WoW Classic 한국어 클라이언트에서 `/roll` 명령어로 발생하는 시스템 메시지를 감지하고 자동으로 집계하는 기능입니다.

## 현재 구현 상태

### ✅ 해결된 부분
1. **타이머 작동**: 첫 주사위 굴리기 시 세션이 시작되고 설정된 시간(기본 20초) 후 결과 출력
2. **조사 토큰 처리**: 한국어 클라이언트의 조사 토큰(`|1이;가;`, `|1을;를;`, `|4이;가;` 등) 인식
3. **메시지 감지**: "주사위 관련 메시지 감지됨" 출력 확인
4. **토큰 제거 후 매칭**: 전처리를 통한 패턴 매칭 부분적 성공

### ❌ 미해결 문제
**주사위 값이 실제로 집계되지 않음** - "집계된 주사위가 없습니다" 메시지만 출력

## 문제 분석

### 1. 시스템 메시지 형식
```
실제 메시지: "우르사|1이;가; 주사위 굴리기를 하여 100|4이;가; 나왔습니다. (1-100)"
토큰 제거 후: "우르사 주사위 굴리기를 하여 100 나왔습니다. (1-100)"
```

### 2. 현재 코드 동작 흐름
```lua
1. CHAT_MSG_SYSTEM 이벤트 수신 ✅
2. 주사위 메시지 감지 ✅
3. 조사 토큰 전처리 ✅
4. 패턴 매칭 시도 ⚠️ (부분적 성공)
5. AddRoll 호출 ❌ (호출되지 않음)
6. 세션 종료 시 "집계된 주사위가 없습니다" 출력
```

### 3. 디버그 로그 분석
```
[FoxChatRollTracker] System message: 우르사|1이;가; 주사위 굴리기를 하여 100|4이;가; 나왔습니다. (1-100)
  -> 주사위 관련 메시지 감지됨
  -> 토큰 제거 후: 우르사 주사위 굴리기를 하여 100 나왔습니다. (1-100)
  -> 토큰 제거 후 매칭 성공
[RT:FinishSession] 세션 종료 시작
  세션 지속 시간: 20초
  총 0종류 주사위, 최대 0명 참여
집계된 주사위가 없습니다.
```

### 4. 의심되는 문제점

#### A. 패턴 매칭은 성공하지만 AddRoll이 호출되지 않음
- "토큰 제거 후 매칭 성공" 로그는 나오지만
- "[주사위 추가]" 로그가 없음
- `RT:AddRoll()` 함수가 실제로 호출되지 않는 것으로 보임

#### B. 이름 정규화 문제
- `NormalizeName()` 함수에서 이름이 nil이나 빈 문자열로 반환될 가능성
- 토큰 제거 과정에서 이름이 손상되었을 가능성

#### C. 로스터 체크 실패
- 플레이어가 로스터에 없어서 AddRoll에서 early return
- 솔로 플레이 시 로스터 구축 문제

## 현재 코드 핵심 부분

### 패턴 매칭 및 AddRoll 호출 부분
```lua
-- 토큰 제거 후 매칭 (라인 436-453)
if not (name and roll) and cleanMsg ~= msg then
    if i <= 2 then
        name, roll, minv, maxv = cleanMsg:match("(.+) 주사위 굴리기를 하여 (%d+) 나왔습니다%. %((%d+)%-(%d+)%)")
        -- ... 추가 패턴 시도 ...
        if name and roll then
            if addon.DebugMode then
                print("  -> 토큰 제거 후 매칭 성공")
            end
            break
        end
    end
end

-- AddRoll 호출 부분 (라인 492-495)
if name and roll and minv and maxv then
    name = NormalizeName(name)
    roll, minv, maxv = tonumber(roll), tonumber(minv), tonumber(maxv)
    if name and roll and minv and maxv then
        if addon.DebugMode then
            print(string.format("[FoxChatRollTracker] Roll detected: %s rolled %d (%d-%d)", name, roll, minv, maxv))
        end
        RT:AddRoll(name, roll, minv, maxv)
    end
end
```

## 추가 조사 필요 사항

1. **패턴 매칭 후 변수 상태 확인**
   - `name`, `roll`, `minv`, `maxv` 값이 실제로 설정되는지
   - break 후 이 변수들이 유지되는지

2. **NormalizeName 함수 동작 확인**
   - "우르사" → 정규화 → nil이 되는지 확인

3. **로스터 상태 확인**
   - AddRoll 시점에 roster가 비어있는지
   - 플레이어 이름이 roster에 있는지

## 요청사항
위 문제를 해결하기 위해 다음 부분을 중점적으로 검토 부탁드립니다:
1. 패턴 매칭 성공 후 AddRoll이 호출되지 않는 원인
2. 루프 내에서 break 후 변수가 유지되는지 확인
3. 더 효과적인 디버깅 방법 제안