# WoW Classic 1.12 미니맵 버튼 구현 가이드

## 문제점
WoW Classic 1.12에서는 현대 WoW와 달리 `OnClick` 이벤트의 `arg1` 파라미터가 제대로 전달되지 않아 좌/우 클릭 구분이 어렵습니다.

## 해결 방법

### 핵심 원리
`OnMouseDown` 이벤트에서 `IsMouseButtonDown()` API를 사용하여 어떤 버튼이 눌렸는지 감지하고, 이 정보를 저장했다가 `OnClick`에서 사용합니다.

### 구현 코드

```lua
local function CreateMinimapButton()
    -- 메인 버튼 생성
    local button = CreateFrame("Button", "YourAddonMinimapButton", Minimap)
    button:SetFrameStrata("MEDIUM")
    button:SetWidth(33)
    button:SetHeight(33)
    button:SetFrameLevel(8)
    button:SetToplevel(true)
    button:SetHighlightTexture("Interface\\Minimap\\UI-Minimap-ZoomButton-Highlight")

    -- 모든 클릭 이벤트 등록
    button:RegisterForClicks("AnyUp")
    button:RegisterForDrag("LeftButton")

    -- 시각적 요소 추가
    local overlay = button:CreateTexture(nil, "OVERLAY")
    overlay:SetWidth(53)
    overlay:SetHeight(53)
    overlay:SetTexture("Interface\\Minimap\\MiniMap-TrackingBorder")
    overlay:SetPoint("TOPLEFT")

    local icon = button:CreateTexture(nil, "BACKGROUND")
    icon:SetWidth(20)
    icon:SetHeight(20)
    icon:SetTexture("Interface\\Icons\\YourIcon")
    icon:SetTexCoord(0.05, 0.95, 0.05, 0.95)
    icon:SetPoint("TOPLEFT", 7, -6)

    -- 상태 변수
    local isDragging = false
    local mouseDownButton = nil

    -- 마우스 버튼 감지
    button:SetScript("OnMouseDown", function()
        -- WoW 1.12에서 어떤 버튼이 눌렸는지 확인
        local leftDown = IsMouseButtonDown("LeftButton")
        local rightDown = IsMouseButtonDown("RightButton")

        if leftDown then
            mouseDownButton = "LeftButton"
        elseif rightDown then
            mouseDownButton = "RightButton"
        end
    end)

    -- 드래그 처리
    button:SetScript("OnDragStart", function()
        isDragging = true
        button:LockHighlight()
        -- 드래그 중 위치 업데이트
        button:SetScript("OnUpdate", function()
            local xpos, ypos = GetCursorPosition()
            local xmin, ymin = Minimap:GetCenter()

            xpos = xmin - xpos / Minimap:GetEffectiveScale() + 70
            ypos = ypos / Minimap:GetEffectiveScale() - ymin - 70

            -- 각도 저장 (SavedVariables에)
            YourAddonDB.minimapPos = math.deg(math.atan2(ypos, xpos))
            UpdateMinimapButtonPosition()
        end)
    end)

    button:SetScript("OnDragStop", function()
        button:SetScript("OnUpdate", nil)
        button:UnlockHighlight()
        isDragging = false
    end)

    -- 클릭 처리
    button:SetScript("OnClick", function()
        if isDragging then
            mouseDownButton = nil
            return
        end

        -- 저장된 버튼 정보 사용
        if mouseDownButton == "RightButton" then
            -- 우클릭 동작
            HandleRightClick()
        else
            -- 좌클릭 동작 (기본값)
            HandleLeftClick()
        end

        mouseDownButton = nil
    end)

    -- 툴팁
    button:SetScript("OnEnter", function()
        GameTooltip:SetOwner(button, "ANCHOR_LEFT")
        GameTooltip:SetText("애드온 이름")
        GameTooltip:AddLine("좌클릭: 설정창 열기", 1, 1, 1)
        GameTooltip:AddLine("우클릭: 기타 기능", 1, 1, 1)
        GameTooltip:AddLine("좌클릭 드래그: 버튼 이동", 1, 1, 1)
        GameTooltip:Show()
    end)

    button:SetScript("OnLeave", function()
        GameTooltip:Hide()
    end)

    button:Show()
    return button
end
```

## 미니맵 버튼 위치 업데이트

```lua
function UpdateMinimapButtonPosition()
    local button = YourAddonMinimapButton
    if not button then return end

    local angle = YourAddonDB.minimapPos or 45
    button:ClearAllPoints()
    button:SetPoint("TOPLEFT", Minimap, "TOPLEFT",
        54 - (78 * math.cos(math.rad(angle))),
        (78 * math.sin(math.rad(angle))) - 55)
    button:Show()
end
```

## 주요 포인트

### 1. 클릭 감지 문제
- **문제**: WoW Classic 1.12에서는 `OnClick`, `OnMouseUp`, `OnMouseDown` 이벤트의 `arg1`이 nil
- **해결**: `IsMouseButtonDown("LeftButton")` 및 `IsMouseButtonDown("RightButton")` 사용

### 2. RegisterForClicks
- `"AnyUp"` 사용하여 모든 버튼 클릭 감지
- 특정 버튼만 필요하면 `"LeftButtonUp", "RightButtonUp"` 사용

### 3. 프레임 계층
- `SetFrameStrata("MEDIUM")` - 적절한 레벨 설정
- `SetFrameLevel(8)` - 다른 UI 요소와 겹치지 않도록
- `SetToplevel(true)` - 최상위에 표시

### 4. 드래그 처리
- 드래그 중에는 클릭 이벤트 무시 (isDragging 플래그 사용)
- OnUpdate를 사용한 실시간 위치 업데이트

## 실패한 접근 방법들 (피해야 할 것)

1. **OnClick의 arg1 사용** - WoW 1.12에서는 nil
2. **PreClick/PostClick** - arg1이 여전히 nil
3. **별도의 좌/우 버튼 프레임 오버레이** - 한쪽이 다른 쪽을 막는 문제 발생
4. **OnMouseUp/OnMouseDown의 arg1 직접 사용** - 역시 nil

## 테스트 방법

```lua
-- 디버그 메시지 추가
button:SetScript("OnMouseDown", function()
    local leftDown = IsMouseButtonDown("LeftButton")
    local rightDown = IsMouseButtonDown("RightButton")

    DEFAULT_CHAT_FRAME:AddMessage("Left: " .. tostring(leftDown) .. ", Right: " .. tostring(rightDown))

    -- 이하 동일...
end)
```

## 참고사항
- WoW Classic 1.12 전용 해결 방법
- 현대 WoW나 TBC, WotLK에서는 arg1이 정상 작동할 수 있음
- FoxGuildCal, FoxChat 등 기존 애드온 참고 가능