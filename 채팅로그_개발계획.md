# FoxChat 채팅 로그 기능 개발 계획 (성능 최적화 버전)

## 1. 개요
FoxChat 에드온의 자동화 탭에 채팅 로그 기능을 추가하여 귓속말과 파티 대화 내용을 일자별로 저장하고 조회할 수 있도록 구현
**WoW 클래식 환경에서 성능과 안정성을 최우선으로 설계**

## 2. 핵심 설계 원칙

### 2.1 성능 최적화 원칙
- **핫패스에서 문자열 포맷 최소화**: 로그 저장 시 숫자 타임스탬프만 저장, UI에서만 포맷
- **키/필드 축약**: SavedVariables 크기 최소화를 위해 짧은 키 사용
- **가상 스크롤 적용**: 보이는 부분만 렌더링
- **비동기 검색**: 대량 데이터 검색 시 프레임 드롭 방지
- **보관/청소 최소 실행**: 로그인 시 또는 날짜 변경 시 1회만

### 2.2 WoW 클래식 제약사항 대응
- SavedVariables는 **/reload** 또는 **로그아웃** 시에만 디스크 저장
- 애드온은 로컬 파일 직접 저장 불가 → 복사용 팝업 제공
- 자정 저장 개념 없음 → 메모리에서만 버킷 교체

## 3. 데이터 구조 (최적화)

### 3.1 저장 구조
```lua
FoxChatDB.chatLogs = {
  ["20241229"] = {  -- YYYYMMDD 형식 (짧고 정렬 쉬움)
    -- 축약 키: ts=타임스탬프, ch=채널코드, s=발신자, t=대상, m=메시지, o=발신여부
    { ts=1735454121, ch=1, s="플레이어", t="상대", m="안녕하세요", o=1 },
    { ts=1735454175, ch=3, s="파티원", m="던전 가실분?", o=0 },
  },
}

-- 채널 코드 매핑 (저장 크기 최소화)
-- 1: WHISPER_OUT (내가 보낸 귓말)
-- 2: WHISPER_IN  (받은 귓말)
-- 3: PARTY
-- 4: RAID
-- 5: GUILD
-- 6: PARTY_LEADER
-- 7: RAID_LEADER
```

### 3.2 설정 구조
```lua
FoxChatDB.chatLogConfig = {
    enabled = false,
    channels = {
        WHISPER = true,
        PARTY = true,
        RAID = false,   -- 기본 OFF (로그 폭증 방지)
        GUILD = false,  -- 기본 OFF
    },
    retentionDays = 7,  -- 1~30일
    sessionTimeout = 1800,  -- 30분 (UI 표시용)
}
```

## 4. UI 구성 (Text Art)

### 4.1 자동화 탭 내 위치
```
┌─────────────────────────────────────────────────────────────┐
│ [광고 설정] [선입자] [파티 자동화] [주사위] [채팅 로그] ←NEW│
└─────────────────────────────────────────────────────────────┘
```

### 4.2 채팅 로그 UI 레이아웃
```
┌────────────────────────────────────────────────────────────┐
│ 채팅 로그 설정                                             │
├────────────────────────────────────────────────────────────┤
│ □ 채팅 로그 기능 사용                                     │
│                                                            │
│ 로그 대상 채널:                                           │
│ ☑ 귓속말  ☑ 파티  □ 공격대  □ 길드                     │
│                                                            │
│ 보관 기간: [▼ 7일 ]  (최대 30일)                        │
│ 일별 최대: [10000] 줄 (메모리 보호)                       │
│                                                            │
├────────────────────────────────────────────────────────────┤
│ 로그 보기                                                  │
│                                                            │
│ [오늘] [어제] [최근7일] [◀] 2024-12-29 [▶] [달력...]    │
│                              ^^^^^^^^^^^                   │
│                            (날짜 선택 영역)                │
│                                                            │
│ 검색: [____________] [🔍]  필터: [전체 ▼]                │
│                                                            │
│ ┌──────────────────────────────────────────────────────┐ │
│ │ ┌────────────────────────────────────────────────┐  │ │
│ │ │ ===== 새 대화 세션: 14:35 =====                │↑│ │
│ │ │ [14:35:21][귓] 나 → 우르사: 안녕하세요?       │ │ │
│ │ │ [14:35:30][귓] 우르사 → 나: 네 안녕하세요     │ │ │
│ │ │ [14:36:15][파티] 플레이어1: 던전 가실분?      │ │ │
│ │ │ [14:36:22][파티] 나: 저요!                     │ │ │
│ │ │                                                │ │ │
│ │ │ ===== 새 대화 세션: 18:20 =====                │ │ │
│ │ │ [18:20:11][파티] 나: 퀘스트 같이하실분         │ │ │
│ │ │ [18:20:25][파티] 플레이어2: 넵 갑시다         │ │ │
│ │ │ [18:21:03][파티] 플레이어3: 저도요            │ │ │
│ │ │                                                │↓│ │
│ │ └────────────────────────────────────────────────┘  │ │
│ └──────────────────────────────────────────────────────┘ │
│                                                            │
│ [내보내기] [선택 날짜 삭제] [모두 삭제]                   │
└────────────────────────────────────────────────────────────┘

[달력...] 클릭 시 날짜 브라우저 팝업:
┌─────────────────────────────────────────┐
│ 날짜 선택                               │
├─────────────────────────────────────────┤
│ 검색: [____________]                    │
│                                         │
│ ┌───────────────────────────────────┐  │
│ │ • 2024-12-29 (1,234 줄)         ↑│  │
│ │ • 2024-12-28 (987 줄)           │ │  │
│ │ • 2024-12-27 (456 줄)           │ │  │
│ │ • 2024-12-26 (789 줄)           │ │  │
│ │ • 2024-12-25 (234 줄)           │ │  │
│ │ • 2024-12-24 (567 줄)           ↓│  │
│ └───────────────────────────────────┘  │
│                                         │
│        [선택]    [취소]                 │
└─────────────────────────────────────────┘

[내보내기] 클릭 시 팝업:
┌─────────────────────────────────────────┐
│ 채팅 로그 내보내기                       │
├─────────────────────────────────────────┤
│ 아래 텍스트를 복사하여 저장하세요:      │
│ ┌───────────────────────────────────┐  │
│ │ [여기에 로그 텍스트 표시]         │  │
│ │ Ctrl+A로 전체 선택               │  │
│ │ Ctrl+C로 복사                    │  │
│ └───────────────────────────────────┘  │
│              [닫기]                      │
└─────────────────────────────────────────┘
```

## 5. 핵심 구현 코드

### 5.1 FoxChatLogger.lua (성능 최적화 버전)
```lua
local addonName, addon = ...
addon.ChatLogger = addon.ChatLogger or {}
local CL = addon.ChatLogger

-- === 설정 기본값 ===
CL.cfg = {
  enabled = false,
  channels = { WHISPER=true, PARTY=true, RAID=false, GUILD=false },
  retentionDays = 7,
  sessionTimeout = 1800,
}

-- 채널 코드 테이블 (저장 크기 최소화)
local CH = {
  WHISPER_IN    = 2,
  WHISPER_OUT   = 1,
  PARTY         = 3,
  PARTY_LEADER  = 6,
  RAID          = 4,
  RAID_LEADER   = 7,
  GUILD         = 5,
}

local EVENT2CODE = {
  CHAT_MSG_WHISPER        = CH.WHISPER_IN,
  CHAT_MSG_WHISPER_INFORM = CH.WHISPER_OUT,
  CHAT_MSG_PARTY          = CH.PARTY,
  CHAT_MSG_PARTY_LEADER   = CH.PARTY_LEADER,
  CHAT_MSG_RAID           = CH.RAID,
  CHAT_MSG_RAID_LEADER    = CH.RAID_LEADER,
  CHAT_MSG_GUILD          = CH.GUILD,
}

-- 날짜 키 캐싱 (핫패스 최적화)
local curDayKey, curDayStart

local function InitDayCache()
  local now = GetServerTime()
  curDayKey = date("%Y%m%d", now)
  local y = tonumber(curDayKey:sub(1,4))
  local m = tonumber(curDayKey:sub(5,6))
  local d = tonumber(curDayKey:sub(7,8))
  curDayStart = time{year=y, month=m, day=d, hour=0}
end

InitDayCache()  -- 초기화

-- 채널 허용 확인
local function ChannelAllowed(code)
  if code == CH.WHISPER_IN or code == CH.WHISPER_OUT then
    return CL.cfg.channels.WHISPER
  elseif code == CH.PARTY or code == CH.PARTY_LEADER then
    return CL.cfg.channels.PARTY
  elseif code == CH.RAID or code == CH.RAID_LEADER then
    return CL.cfg.channels.RAID
  elseif code == CH.GUILD then
    return CL.cfg.channels.GUILD
  end
  return false
end

-- 메시지 저장 (핫패스 최적화 - date 호출 제거)
local MAX_LINES_PER_DAY = 10000

local function SaveLog(ts, code, sender, target, msg, outgoing)
  if not CL.cfg.enabled then return end
  if not ChannelAllowed(code) then return end

  -- curDayKey 사용 (date 호출 없음)
  local bucket = FoxChatDB.chatLogs[curDayKey]
  if not bucket then
    bucket = {}
    FoxChatDB.chatLogs[curDayKey] = bucket
  end

  -- 일별 최대 라인 수 제한
  if #bucket >= MAX_LINES_PER_DAY then
    table.remove(bucket, 1)  -- 가장 오래된 항목 제거
  end

  -- 축약 키로 저장
  bucket[#bucket+1] = {
    ts = ts,
    ch = code,
    s  = sender,
    t  = target,
    m  = msg,
    o  = outgoing and 1 or 0,
  }
end

-- 오래된 로그 삭제 (로그인/날짜 변경 시 1회)
function CL:CleanOldLogs()
  local keep = tonumber(CL.cfg.retentionDays) or 7
  keep = math.max(1, math.min(30, keep))
  local now = GetServerTime()

  for dayKey in pairs(FoxChatDB.chatLogs) do
    local y = tonumber(dayKey:sub(1,4))
    local m = tonumber(dayKey:sub(5,6))
    local d = tonumber(dayKey:sub(7,8))
    local t0 = time({year=y, month=m, day=d, hour=0, min=0, sec=0})
    if t0 and (now - t0) > keep * 86400 then
      FoxChatDB.chatLogs[dayKey] = nil
    end
  end
end

-- 자정 롤오버 감지 (캐시 사용)
local function MaybeRolloverCached()
  local now = GetServerTime()
  if not curDayStart or now - curDayStart >= 86400 then
    InitDayCache()  -- 날짜 키 재계산
    C_Timer.After(2, function() CL:CleanOldLogs() end)
  end
end

-- 이벤트 핸들러 (통합)
local f = CreateFrame("Frame")
CL.frame = f

-- 귓속말 대상 추적
hooksecurefunc("SendChatMessage", function(msg, chatType, lang, target)
  if chatType == "WHISPER" and target and target ~= "" then
    CL.lastWhisperTarget = Ambiguate(target, "none"):gsub("%-.+$","")
  end
end)

f:SetScript("OnEvent", function(self, event, msg, sender, ...)
  local code = EVENT2CODE[event]
  if not code then
    if event == "PLAYER_LOGIN" then
      C_Timer.After(2, function() CL:CleanOldLogs() end)
    end
    return
  end

  local ts = GetServerTime()
  local target, outgoing

  if code == CH.WHISPER_OUT then
    outgoing = true
    target = CL.lastWhisperTarget  -- 훅에서 추적한 대상 사용
  end

  SaveLog(ts, code, sender, target, msg, outgoing)
  MaybeRolloverCached()  -- 자정 체크 (캐시 사용)
end)

-- 이벤트 등록
f:RegisterEvent("PLAYER_LOGIN")
f:RegisterEvent("CHAT_MSG_WHISPER")
f:RegisterEvent("CHAT_MSG_WHISPER_INFORM")
f:RegisterEvent("CHAT_MSG_PARTY")
f:RegisterEvent("CHAT_MSG_PARTY_LEADER")
f:RegisterEvent("CHAT_MSG_RAID")
f:RegisterEvent("CHAT_MSG_RAID_LEADER")
f:RegisterEvent("CHAT_MSG_GUILD")

-- 5분마다 자정 체크 (채팅 없는 시간대 대비)
local ticker = C_Timer.NewTicker(300, MaybeRolloverCached)
```

### 5.2 UI 렌더링 (세션 구분)
```lua
-- UI에서만 포맷 수행
local function FormatLine(entry, prevTs, sessionTimeout)
  local lines = {}

  -- 세션 구분 (30분 이상 간격)
  if prevTs and (entry.ts - prevTs) > (sessionTimeout or 1800) then
    lines[#lines+1] = ("===== 새 대화 세션: %s ====="):format(date("%H:%M", entry.ts))
  end

  local ch = entry.ch
  local chLabel = (ch==1 or ch==2) and "귓"
                or (ch==3 or ch==6) and "파티"
                or (ch==4 or ch==7) and "공대"
                or (ch==5) and "길드"
                or "기타"

  local who
  if ch==1 then
    who = ("나 → %s"):format(entry.t or "?")
  elseif ch==2 then
    who = ("%s → 나"):format(entry.s or "?")
  else
    who = entry.s or "?"
  end

  lines[#lines+1] = ("[%s][%s] %s: %s"):format(
    date("%H:%M:%S", entry.ts),
    chLabel,
    who,
    entry.m or ""
  )

  return table.concat(lines, "\n")
end
```

### 5.3 비동기 검색 (프레임 드롭 방지)
```lua
local function SearchAsync(entries, keyword, onProgress, onComplete)
  local i, n, step = 1, #entries, 300
  local results = {}

  local function tick()
    local stop = math.min(i + step - 1, n)
    for k = i, stop do
      if string.find(entries[k].m or "", keyword, 1, true) then
        results[#results+1] = k
      end
    end

    if onProgress then
      onProgress(stop/n)  -- 진행률 콜백
    end

    i = stop + 1
    if i <= n then
      C_Timer.After(0, tick)  -- 다음 프레임에 계속
    else
      if onComplete then
        onComplete(results)
      end
    end
  end

  tick()
end
```

### 5.4 날짜 선택 UI (Prev/Next 방식)
```lua
-- 날짜 이동 함수
local function ShiftDay(dayKey, delta)
  local y = tonumber(dayKey:sub(1,4))
  local m = tonumber(dayKey:sub(5,6))
  local d = tonumber(dayKey:sub(7,8))
  local t = time{year=y, month=m, day=d, hour=0}
  local t2 = t + delta * 86400
  return date("%Y%m%d", t2)
end

-- 날짜 네비게이션 버튼
local function CreateDateNav(parent)
  local frame = CreateFrame("Frame", nil, parent)
  frame:SetSize(300, 30)

  -- 오늘 버튼
  local todayBtn = CreateFrame("Button", nil, frame, "UIPanelButtonTemplate")
  todayBtn:SetSize(50, 25)
  todayBtn:SetPoint("LEFT", 0, 0)
  todayBtn:SetText("오늘")
  todayBtn:SetScript("OnClick", function()
    local today = date("%Y%m%d")
    if FoxChatDB.chatLogs[today] then
      SelectDay(today)
    end
  end)

  -- 어제 버튼
  local yesterdayBtn = CreateFrame("Button", nil, frame, "UIPanelButtonTemplate")
  yesterdayBtn:SetSize(50, 25)
  yesterdayBtn:SetPoint("LEFT", todayBtn, "RIGHT", 5, 0)
  yesterdayBtn:SetText("어제")

  -- 이전 날짜 버튼
  local prevBtn = CreateFrame("Button", nil, frame, "UIPanelButtonTemplate")
  prevBtn:SetSize(25, 25)
  prevBtn:SetPoint("LEFT", yesterdayBtn, "RIGHT", 10, 0)
  prevBtn:SetText("◀")
  prevBtn:SetScript("OnClick", function()
    local dk = ShiftDay(UIState.selectedDayKey, -1)
    if FoxChatDB.chatLogs[dk] then
      SelectDay(dk)
    end
  end)

  -- 날짜 표시
  local dateLabel = frame:CreateFontString(nil, "OVERLAY", "GameFontNormal")
  dateLabel:SetPoint("LEFT", prevBtn, "RIGHT", 5, 0)
  dateLabel:SetText("2024-12-29")
  frame.dateLabel = dateLabel

  -- 다음 날짜 버튼
  local nextBtn = CreateFrame("Button", nil, frame, "UIPanelButtonTemplate")
  nextBtn:SetSize(25, 25)
  nextBtn:SetPoint("LEFT", dateLabel, "RIGHT", 5, 0)
  nextBtn:SetText("▶")
  nextBtn:SetScript("OnClick", function()
    local dk = ShiftDay(UIState.selectedDayKey, +1)
    if FoxChatDB.chatLogs[dk] then
      SelectDay(dk)
    end
  end)

  -- 달력 버튼
  local calendarBtn = CreateFrame("Button", nil, frame, "UIPanelButtonTemplate")
  calendarBtn:SetSize(60, 25)
  calendarBtn:SetPoint("LEFT", nextBtn, "RIGHT", 10, 0)
  calendarBtn:SetText("달력...")
  calendarBtn:SetScript("OnClick", function()
    ShowDateBrowser()  -- 날짜 브라우저 팝업
  end)

  return frame
end
```

### 5.5 가상 스크롤 구현 (FauxScrollFrame - Classic 호환)
```lua
-- Classic 호환 스크롤 프레임
local function CreateLogViewer(parent)
  local frame = CreateFrame("Frame", nil, parent)
  frame:SetSize(500, 300)

  -- 스크롤 프레임
  local scroll = CreateFrame("ScrollFrame", nil, frame, "FauxScrollFrameTemplate")
  scroll:SetPoint("TOPLEFT", 0, 0)
  scroll:SetPoint("BOTTOMRIGHT", -30, 0)

  -- 표시 영역
  local content = CreateFrame("Frame", nil, scroll)
  content:SetSize(470, 300)
  scroll:SetScrollChild(content)

  -- 라인 버튼들 (재사용)
  local lines = {}
  local LINE_HEIGHT = 14
  local MAX_LINES = 20

  for i = 1, MAX_LINES do
    local line = content:CreateFontString(nil, "OVERLAY", "GameFontNormalSmall")
    line:SetPoint("TOPLEFT", 5, -(i-1) * LINE_HEIGHT)
    line:SetPoint("RIGHT", -5, 0)
    line:SetJustifyH("LEFT")
    line:SetHeight(LINE_HEIGHT)
    lines[i] = line
  end

  -- 업데이트 함수
  local function UpdateList(data)
    local offset = FauxScrollFrame_GetOffset(scroll)
    for i = 1, MAX_LINES do
      local dataIndex = i + offset
      if dataIndex <= #data then
        lines[i]:SetText(data[dataIndex])
        lines[i]:Show()
      else
        lines[i]:Hide()
      end
    end
    FauxScrollFrame_Update(scroll, #data, MAX_LINES, LINE_HEIGHT)
  end

  frame.UpdateList = UpdateList
  return frame
end
```

## 6. 구현 파일 구조

### 6.1 새로 생성할 파일
- `FoxChatLogger.lua` - 채팅 로그 핵심 모듈 (위 코드)
- `FoxChat_Config_ChatLog.lua` - UI 구성

### 6.2 수정할 파일
- `FoxChat.toc` - 새 파일 추가
- `FoxChat_Config_TabUI.lua` - 채팅 로그 탭 추가

## 7. 성능 가이드

### 7.1 예상 성능
- **로그 저장 오버헤드**: 이벤트당 테이블 1개 + 필드 몇 개 → 문제없음
- **메모리 사용**: 1,000줄 ≈ 수백 KB (한국어 UTF-8 기준)
- **권장 설정**: 7~14일 보관, RAID/GUILD 기본 OFF → 수 MB 이하 유지

### 7.2 SavedVariables 관리
- **디스크 저장 시점**: /reload 또는 로그아웃 시에만
- **자정 처리**: 메모리에서 버킷 교체만 (디스크 저장 X)
- **크기 제한**: 수십 MB 넘지 않도록 보관 기간 제한

## 8. 개발 순서

### Phase 1: 핵심 구조 (1일)
1. FoxChatLogger.lua 기본 구조
2. 이벤트 핸들러 통합
3. 축약 키 저장 구조

### Phase 2: 로깅 기능 (1일)
1. 메시지 수집/저장 (epoch timestamp)
2. 자정 롤오버 (메모리만)
3. 오래된 로그 정리 (로그인 시)

### Phase 3: UI 구현 (2일)
1. 설정 UI (체크박스, 드롭다운)
2. 가상 스크롤 뷰어 (HybridScrollFrame)
3. 세션 구분 표시 (UI단)
4. 날짜 선택기

### Phase 4: 부가 기능 (1일)
1. 비동기 검색 (청크 처리)
2. 내보내기 (EditBox 복사)
3. 필터링
4. 테스트

## 9. 테스트 계획

### 9.1 성능 테스트
- 1만 줄 로그에서 검색 속도
- 스크롤 시 프레임 레이트
- 메모리 사용량 모니터링
- 자정 롤오버 동작

### 9.2 안정성 테스트
- 강제 종료 시 데이터 유실 확인
- /reload 후 데이터 지속성
- 대량 메시지 동시 수신
- 다국어 문자 처리

## 10. 주의사항

### 10.1 WoW 클래식 제약
- 애드온은 파일 직접 저장 불가
- SavedVariables는 로그아웃/리로드 시만 저장
- 강제 저장 API 없음

### 10.2 성능 최적화 필수
- 문자열 포맷은 UI에서만
- 축약 키로 저장 크기 최소화
- 가상 스크롤로 렌더링 최적화
- 검색은 비동기 처리

## 11. 예상 문제 및 해결방안

| 문제 | 원인 | 해결방안 |
|------|------|----------|
| 프레임 드롭 | 대량 데이터 한번에 처리 | 청크 처리, C_Timer 활용 |
| SavedVariables 크기 | 긴 키명, 문자열 타임스탬프 | 축약 키, epoch 숫자 저장 |
| 자정 데이터 유실 | 자동 저장 기대 | 메모리 버킷 교체만, 저장은 리로드 시 |
| 귓말 대상 추출 실패 | WHISPER_INFORM 이벤트 제약 | SendChatMessage 훅으로 대상 추적 |
| 내보내기 불가 | 파일 저장 API 없음 | EditBox 팝업으로 복사 유도 |
| 날짜 선택 UI 부담 | 날짜 많아지면 드롭다운 비효율 | Prev/Next 버튼 + 날짜 브라우저 팝업 |
| 핫패스 date() 호출 | 매 메시지마다 날짜 계산 | dayKey 캐싱으로 date() 호출 최소화 |
| 메모리 폭증 | 일별 로그 무제한 | MAX_LINES_PER_DAY 제한 (10,000줄) |

## 12. 완성 예상 효과
- 일일 대화량 약 500~1,000줄 기준 안정적 동작
- 7일 보관 시 약 1~2MB SavedVariables 사용
- 프레임 드롭 없는 부드러운 스크롤
- 빠른 검색 (1만 줄 기준 1초 이내)