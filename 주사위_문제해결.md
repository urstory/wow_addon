# FoxChat 주사위 집계 - 이름 정규화 문제 해결

## 현재 문제
- 파싱은 성공: "우르사" 이름과 "100" 값이 정상적으로 추출됨
- **NormalizeName 함수에서 "우르사"가 nil로 변환됨**
- 결과적으로 AddRoll이 실패하여 집계되지 않음

## 테스트 절차

### 1. 디버그 모드 활성화
```
/fcroll debug on
```

### 2. 이름 정규화 단독 테스트
```
/fcroll testname 우르사
```
이 명령으로 "우르사"가 어떻게 처리되는지 확인

### 3. 전체 메시지 테스트
```
/fcroll testmsg
```
기본 테스트 메시지로 전체 파싱 과정 확인

### 4. 실제 주사위 테스트
```
/roll
```

## 수정 내역

### 1. NormalizeName 함수 개선
- 토큰 제거 패턴 수정: 세미콜론이 두 개 있는 경우만 제거
- 디버그 로그 추가로 각 단계별 변환 과정 확인
- Ambiguate 함수 호출 시 변경사항 로깅

### 2. 디버그 출력 강화
- 이름 정규화 전후 상태 출력
- 바이트 단위 분석 기능 추가
- 단계별 변환 과정 추적

## 예상 원인

1. **Ambiguate 함수 문제**: WoW API가 예상과 다르게 동작
2. **인코딩 문제**: 한글 캐릭터 처리 중 문제 발생
3. **숨겨진 문자**: 보이지 않는 제어 문자가 포함되어 있을 가능성

## 즉시 해결 방법

만약 급하게 사용해야 한다면, NormalizeName 함수를 임시로 단순화:

```lua
local function NormalizeName(name)
    if not name or name == "" then return nil end
    -- 최소한의 처리만
    name = name:gsub("님$", "")
    name = name:match("^%s*(.-)%s*$") or name
    return name
end
```

## 다음 단계

1. `/fcroll testname 우르사` 실행 결과 확인
2. 결과에 따라 Ambiguate 함수 비활성화 또는 수정
3. 필요시 인코딩 관련 처리 추가