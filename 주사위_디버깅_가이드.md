# FoxChat 주사위 집계 디버깅 가이드

## 문제 진단 절차

### 1단계: 디버그 모드 활성화
```
/fcroll debug on
```

### 2단계: 메시지 파싱 테스트
실제 시스템 메시지를 복사하여 테스트:
```
/fcroll testmsg 우르사|1이;가; 주사위 굴리기를 하여 100|4이;가; 나왔습니다. (1-100)
```

이 명령은 다음을 출력합니다:
- 원본 메시지
- 토큰 제거 후 메시지
- 각 패턴별 매칭 시도 결과
- 성공 시 파싱된 값들
- 정규화된 이름
- AddRoll 호출 결과

### 3단계: 실제 주사위 테스트
```
/roll
```

디버그 모드에서 다음 로그가 순서대로 나와야 정상:
1. `[RT] System message: ...` - 시스템 메시지 수신
2. `-> 주사위 관련 메시지 감지됨` - 주사위 메시지 인식
3. `-> 토큰 제거 후: ...` - 토큰 제거 확인
4. `-> 토큰 제거 후 매칭 성공` - 패턴 매칭 성공
5. `[RT] parsed: 이름 => 정규화이름 값 최소 최대` - 파싱 결과
6. `[RT] OK: 이름 값 (최소-최대)` - AddRoll 성공

### 4단계: 문제 원인 파악

#### 증상별 원인:

**"토큰 제거 후 매칭 성공"만 나오고 집계 안됨:**
- `[RT] parsed:` 로그가 없음 → 파싱 후 처리 실패
- `[RT] DROP after normalize/tonumber` → 이름 정규화 실패
- `[RT] DROP: not in roster` → 로스터에 없는 플레이어

**패턴 매칭 자체가 실패:**
- `[RT] PARSE FAIL:` → 모든 패턴이 매칭 실패
- 새로운 메시지 형식일 가능성

**세션은 시작되지만 결과 없음:**
- 로스터 문제일 가능성 높음
- `/fcroll status`로 상태 확인

### 5단계: 빠른 시뮬레이션 테스트
```
/fcroll test
```
5초 후 자동으로 결과가 나와야 함.

## 주요 수정 내역

### 2024년 수정사항:
1. **변수 스코프 문제 해결**: 파싱 변수를 루프 밖에서 한 번만 선언
2. **CleanMessage 함수 추가**: 토큰과 공백을 확실히 제거
3. **세션 우선 시작**: 타이머가 반드시 돌도록 보장
4. **한국어 패턴 개선**: 더 정확한 패턴 추가
5. **워치독 타이머**: C_Timer 실패 대비 OnUpdate 백업
6. **상세 디버그 로그**: 각 단계별 상태 출력

## 로그 예시 (정상 작동)

```
[RT] System message: 우르사|1이;가; 주사위 굴리기를 하여 100|4이;가; 나왔습니다. (1-100)
  -> 주사위 관련 메시지 감지됨
  -> 토큰 제거 후: 우르사 주사위 굴리기를 하여 100 나왔습니다. (1-100)
  -> 토큰 제거 후 매칭 성공
     패턴 #1: ^(.+) 주사위 굴리기를 하여 (%d+) 나왔습니다%. %((%d+)%-(%d+)%)$
     name: 우르사 roll: 100 minv: 1 maxv: 100
[RT] parsed: 우르사 => 우르사 100 1 100
[RT:AddRoll] 호출됨 - player: 우르사 roll: 100 range: 1-100
  sessionActive: false
[RT:StartSession] 세션 시작! 20초 후 결과 출력 예정
[RT] OK: 우르사 100 (1-100)
...
[20초 후]
주사위 (1-100) 우승: 우르사(100) | 최고: 100
```

## 문제 신고 시 필요 정보
1. `/fcroll debug on` 실행 후 전체 디버그 로그
2. `/fcroll testmsg [실제 메시지]` 결과
3. `/fcroll status` 결과
4. 사용 중인 WoW 버전 (클래식/리치왕/등)