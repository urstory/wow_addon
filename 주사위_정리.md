# FoxChat 주사위 자동 집계 기능 구현 분석

## 개요
FoxChat 에드온의 광고 탭에서 주사위 자동 집계 기능은 파티나 공대에서 여러 플레이어가 굴린 주사위를 자동으로 수집하고 우승자를 판별하여 출력하는 시스템입니다.

## 핵심 구현 파일
- `FoxChatRollTracker.lua` - 주사위 집계 핵심 모듈
- `FoxChat_Config_TabUI.lua` - UI 설정 부분

## 동작 방식

### 1. 이벤트 감지
```lua
-- CHAT_MSG_SYSTEM 이벤트 리스너
RT.frame:RegisterEvent("CHAT_MSG_SYSTEM")
```
- WoW의 시스템 메시지를 감지
- "주사위", "roll", "굴리", "나왔습니다" 등의 키워드가 포함된 메시지 필터링

### 2. 메시지 파싱
주사위 메시지 파싱을 위한 다양한 패턴 사용:

#### 한국어 클라이언트 패턴
```lua
-- 주요 패턴들
"^(.-)%s+주사위 굴리기를 하여 (%d+) 나왔습니다%. %((%d+)%-(%d+)%)$"
"^(.-)%s+주사위 굴리기를 하여 (%d+)이 나왔습니다%. %((%d+)%-(%d+)%)$"
"^(.-)%s+주사위 굴리기를 하여 (%d+)가 나왔습니다%. %((%d+)%-(%d+)%)$"
```

#### 영어 클라이언트 패턴
```lua
"^(.+) rolls (%d+) %((%d+)%-(%d+)%)$"
```

### 3. 데이터 처리 흐름

#### 세션 관리
1. 첫 주사위 메시지 감지 시 세션 시작 (`StartSession`)
2. 설정된 시간(기본 20초) 동안 메시지 수집
3. 타이머 만료 시 결과 집계 및 출력 (`FinishSession`)

#### 메시지 정제
```lua
local function CleanMessage(msg)
    -- 조사 토큰 제거: |숫자...; 형태
    msg = msg:gsub("|%d+[^;]*;", "")
    -- 색코드 제거
    msg = msg:gsub("|c%x%x%x%x%x%x%x%x", ""):gsub("|r", "")
    -- 이중 공백을 단일 공백으로
    msg = msg:gsub("%s+", " ")
    -- 앞뒤 공백 제거
    msg = msg:match("^%s*(.-)%s*$") or msg
    return msg
end
```

### 4. 우승자 판별 로직

```lua
-- 각 플레이어의 마지막 주사위 값만 저장
local playerRolls = {}

-- 메시지에서 이름과 값 추출
for _, msg in ipairs(self.rollMessages) do
    local name, roll = -- 패턴 매칭으로 추출
    if name and roll then
        playerRolls[name] = tonumber(roll)  -- 덮어쓰기 방식
    end
end

-- 최고값 찾기
local maxRoll = 0
local winners = {}
for name, roll in pairs(playerRolls) do
    if roll > maxRoll then
        maxRoll = roll
        winners = {name}
    elseif roll == maxRoll then
        table.insert(winners, name)  -- 동점자 처리
    end
end
```

### 5. 결과 출력 형식

```
===== 주사위 결과 =====
우르사 주사위 굴리기를 하여 95 나왔습니다. (1-100)
테스트유저 주사위 굴리기를 하여 72 나왔습니다. (1-100)
우르사 주사위 굴리기를 하여 98 나왔습니다. (1-100)
===================
>> 우승: 우르사 (98) <<
===== 총 3개의 주사위 =====
```

## 주요 기능

### 설정 옵션
- **활성화 여부**: 주사위 집계 ON/OFF
- **집계 시간**: 5/10/15/20/30/60초 선택 가능
- **출력 등수**: 1명(우승자만) ~ 40명까지 설정
- **솔로 모드**: SAY 채널 또는 개인 채팅창 출력 선택

### 특징
1. **다중 주사위 지원**: 같은 사람이 여러 번 굴린 경우 마지막 값으로 갱신
2. **동점자 처리**: 최고점 동점자 모두 공동 우승으로 표시
3. **채널 자동 감지**: 공대/파티/솔로 상황에 따라 적절한 채널로 출력
4. **한국어/영어 클라이언트 지원**: 다양한 패턴으로 양쪽 모두 대응

## 디버그 명령어
```
/fcroll test     - 테스트 시뮬레이션 실행
/fcroll status   - 현재 상태 및 저장된 메시지 확인
/fcroll debug on/off - 디버그 모드 켜기/끄기
/fcroll clear    - 저장된 메시지 초기화
/fcroll parse    - 현재 메시지 파싱 테스트
```

## 구현상 주요 특징

1. **타이머 안정성**: C_Timer.After와 워치독 프레임을 함께 사용하여 타이머 신뢰성 보장
2. **이름 정규화**: Ambiguate API로 서버명 제거, 조사 토큰 제거, "님" 접미사 제거
3. **메시지 분할 전송**: 255바이트 제한을 고려한 안전한 메시지 전송
4. **UTF-8 경계 처리**: 한글 등 멀티바이트 문자 안전 처리
5. **범위별 분리 집계**: 주사위 범위별로 자동 분리하여 집계 및 출력

## 범위별 집계 기능 (2024년 업데이트)

### 동작 방식
- `/주사위` 또는 `/roll` (기본값 1-100)
- `/주사위 60` 또는 `/roll 1 60` (1-60 범위)
- 서로 다른 범위의 주사위는 별도로 집계되어 각각 우승자를 결정

### 데이터 구조
```lua
rollsByRange = {
    ["1-100"] = {
        players = { ["우르사"] = 98, ["플레이어2"] = 72 },
        min = 1,
        max = 100,
        count = 2
    },
    ["1-60"] = {
        players = { ["플레이어3"] = 55, ["플레이어4"] = 45 },
        min = 1,
        max = 60,
        count = 3
    }
}
```

### 출력 형식
```
총 2개의 주사위가 굴려졌고 우승은 우르사(98) 입니다.
[1-60] 총 3개의 주사위가 굴려졌고 우승은 다른유저(55) 입니다.
```
- 기본 범위(1-100)는 범위 표시 생략
- 특수 범위는 [1-60] 형식으로 범위 표시
- 큰 범위부터 먼저 출력

### 테스트 명령어
```
/fcroll test
```
범위별 주사위 시뮬레이션 (1-100과 1-60 혼합)

## 개선 가능한 점
1. 주사위 히스토리 저장 기능
2. 특정 플레이어 제외 기능
3. 커스텀 출력 메시지 포맷 설정